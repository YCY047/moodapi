<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å¿ƒæƒ…æ—¥è¨˜åˆ—è¡¨</title>
</head>
<body>
  <h1>æ‰€æœ‰å¿ƒæƒ…æ—¥è¨˜</h1>
  <div id="mood-container">è¼‰å…¥ä¸­...</div>

  <button onclick="location.href='/'">å›åˆ°ä¸Šå‚³å¿ƒæƒ…</button>
  <br /><br />
  <button onclick="clearToday()">ğŸ§¹ æ¸…é™¤ä»Šå¤©çš„å¿ƒæƒ…æ—¥è¨˜</button>
  <button onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å¿ƒæƒ…æ—¥è¨˜</button>

  <script>
  async function loadMoods() {
  const res = await fetch('/summary/all');
  const data = await res.json();
  const container = document.getElementById('mood-container');
  container.innerHTML = '';

  if (!Object.keys(data).length) {
    container.textContent = 'ç›®å‰æ²’æœ‰ä»»ä½•å¿ƒæƒ…è³‡æ–™';
    return;
  }

  // 1. å±•å¹³æˆä¸€å€‹é™£åˆ—ï¼ŒåŒ…å«æ—¥æœŸã€ä½¿ç”¨è€…ã€æ™‚é–“æˆ³ç­‰
  const allEntries = [];

  for (const [date, users] of Object.entries(data)) {
    for (const [user, entries] of Object.entries(users)) {
      for (const entry of entries) {
        allEntries.push({
          date,
          user,
          entry,
          time: entry.time || '', // å‡è¨­ entry å…§å«æ™‚é–“æˆ³è¨˜ï¼Œè‹¥ç„¡å‰‡ç•™ç©º
        });
      }
    }
  }

  // 2. æŒ‰ç…§æ™‚é–“æˆ³æ’åºï¼ˆç”±èˆŠåˆ°æ–°ï¼‰
  allEntries.sort((a, b) => new Date(a.time) - new Date(b.time));

  // 3. ä¾åºå‘ˆç¾
  let currentDate = '';
  for (const { date, user, entry } of allEntries) {
    if (date !== currentDate) {
      currentDate = date;
      const dateDiv = document.createElement('div');
      dateDiv.innerHTML = `<h3>${date}</h3>`;
      container.appendChild(dateDiv);
    }

    const entryDiv = document.createElement('div');

    let moodHtml = '';
    if (entry.mood && typeof entry.mood.text === 'string' && typeof entry.mood.score !== 'undefined') {
      moodHtml = `å¿ƒæƒ…ï¼š${entry.mood.text}ï¼ˆ${entry.mood.score}åˆ†ï¼‰`;
    }

    let photoHtml = '';
    if (entry.photo && typeof entry.photo.file === 'string') {
      photoHtml = `
        <br />
        <img src="/uploads/${entry.photo.file}" alt="${entry.photo.description || ''}" style="max-width: 200px;" />
        <br />
        æè¿°ï¼š${entry.photo.description || ''}
      `;
    }

    if (!moodHtml && !photoHtml) {
      entryDiv.innerHTML = `<p><strong>${user}</strong>ï¼šç„¡å¿ƒæƒ…è³‡æ–™</p>`;
    } else {
      entryDiv.innerHTML = `<p><strong>${user}</strong>ï¼š${moodHtml}${photoHtml}</p><hr>`;
    }

    container.lastElementChild.appendChild(entryDiv);
  }
}


  async function clearToday() {
    const res = await fetch('/clear/today', { method: 'DELETE' });
    const result = await res.json();
    alert(result.message);
    loadMoods();
  }

  async function clearAll() {
    const res = await fetch('/clear/all', { method: 'DELETE' });
    const result = await res.json();
    alert(result.message);
    loadMoods();
  }

  loadMoods();
  </script>
</body>
</html>
